(function(d){var a={};a.getUID=function(){var a=0;return function(b){return b==="number"?a++:("0000000"+(a++).toString(36)).substr(-8)}}();a.wrapFn=function(c){if(typeof c!=="function")return c;var b="globalAnonymous$$"+a.getUID()+"$"+Math.random().toString(16).substr(3,6);d[b]=function(a){c.call(this,a);delete d[b]};return b};a.queryToJson=function(a){return a.split("&").reduce(function(b,a){a=a.split("=");b[a[0]]=a[1];return b},{})};a.jsonToQuery=function(b){var c=[],a;for(a in b)b.hasOwnProperty(a)&&c.push(a+"="+b[a]);return c.join("&")};var c={getItem:function(a){return!a?null:decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(c,g,a,e,d,f){if(!c||/^(?:expires|max\-age|path|domain|secure)$/i.test(c))return false;var b="";if(a)switch(a.constructor){case Number:b=a===Infinity?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+a;break;case String:b="; expires="+a;break;case Date:b="; expires="+a.toUTCString()}document.cookie=encodeURIComponent(c)+"="+encodeURIComponent(g)+b+(d?"; domain="+d:"")+(e?"; path="+e:"")+(f?"; secure":"");return true},removeItem:function(c,b,a){if(!this.hasItem(c))return false;document.cookie=encodeURIComponent(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(a?"; domain="+a:"")+(b?"; path="+b:"");return true},hasItem:function(a){return!a?false:(new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie)},keys:function(){var b=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),c,a;for(c=b.length,a=0;a<c;a++)b[a]=decodeURIComponent(b[a]);return b}},e=false;try{e=typeof window.localStorage.getItem==="function"&&typeof window.localStorage.setItem==="function"}catch(p){e=false}var g="unset",f=".",o=function(){return e?function(b,a,c){b=b||g;a=b+f+a;return localStorage.setItem(a,c)}:function(b,a,d){b=b||g;a=b+f+a;return c.setItem(a,d)}}(),n=function(){return e?function(b,a){b=b||g;a=b+f+a;return localStorage.getItem(a)}:function(b,a){b=b||g;a=b+f+a;return c.getItem(a)}}();function i(b){var a=$({});a._on=a.on;a._unbind=a.unbind;a.once=function(c){console.log(b+" once "+c);a.one.apply(a,arguments);return this};a.emit=function(c){console.log(b+" emit "+c);a.trigger.apply(a,arguments);return this};a.on=function(c){console.log(b+" on "+c);a._on.apply(a,arguments);return this};a.unbind=function(c){console.log(b+" unbind "+c);a._unbind.apply(a,arguments);return this};return a}function l(b,a){b.once=function(b,c){a.once(b,function(b,a){c(a)})};b.emit=a.emit.bind(a);b.on=function(b,c){a.on(b,function(b,a){c(a)})};b.unbind=a.unbind.bind(a)}var b={};b.PC=function(e,c,b){d.external.CallTQL(a.wrapFn(function(c){var a=null;b(a,c)}),e,c)};b.PC2=function(d,c,a){function e(b){var a=false;return function(){if(a){console.warn("\u91cd\u590d\u7684\u56de\u8c03: ",b.name);return}a=true;return b.apply(this,arguments)}}var b={Method:"CallTQL",FuncName:d,Param:c};a=e(a);window.TDXQuery({request:JSON.stringify(b),onSuccess:function(b){a(null,b)},onFailure:function(b,c){a(c||"\u5e95\u5c42\u9519\u8bef(TDXQuery)",b)}})};b.PC3=function(b,d,c,a){console.log("methodname: "+b);console.log("parmas: "+c);function f(b){var a=false;return function(){if(a){console.warn("\u91cd\u590d\u7684\u56de\u8c03: ",b.name);return}a=true;return b.apply(this,arguments)}}var e={Method:b,FuncName:d,Param:String(c)};a=f(a);window.TDXQuery({request:JSON.stringify(e),onSuccess:function(b){a(null,b)},onFailure:function(b,c){a(c||"\u5e95\u5c42\u9519\u8bef(TDXQuery)",b)}})};b.Android=function(f,b,e){var c=a.wrapFn(function(d,f,c,b){var a=null;e(a,b)});d.tdx_java.Android_SendData("x",f,"TP",b.length,b,c)};b.iOS=function(f,e,d){var c=a.wrapFn(function(f,g,e,b){var a=null;d(a,b)}),b=document.createElement("IFRAME"),g="js-frame:"+[c,0,"fn",f,e,"x"].join(";;");b.setAttriute("src",g);document.documentElement.appendChild(b);b.parentNode.removeChild(b);b=null};function m(a){a.path=a.path||"/TQLEX";$.ajax({url:a.path+"?Entry="+a.entry,data:a.data,type:"POST",success:function(b){a.callback(null,b)},error:function(d,c,b){a.callback(b,null)}})}function j(c){c=c||{};var j=i("ws-client");l(this,j);this.heartbeatInterval=c.heartbeat||10*1e3;this.touchState=false;this.heartbeat=false;this.infoKey="ws_client_login_info";var e=c.protocol||"ws",k=c.ip||"127.0.0.1",g=c.port||"7616",f=c.path||"/WS",h=e+"://"+k+":"+g+f,d=new WebSocket(h),b=this;d.onopen=function(){d.send("touch")};d.onclose=function(a){b.status=false;b.emit("close",a)};d.onerror=function(a){b.status=false;b.emit("error",a)};d.onmessage=function(g){var c=g.data,f=c.split("?")[0];c=c.substr(f.length+1);var d=c.split("|")[0];c=c.substr(d.length+1);d=a.queryToJson(d);var e;if(f==="TQL")e="TQL:"+d.TransKey;else e=f;b.emit(e,{info:d,data:c})};this.ws=d;this.on("touch",function(){b.touchState=true;if(b.heartbeat===false){b.heartbeat=true;b.heartbeatHandle=setInterval(b.ws.send.bind(b.ws,"alive"),b.heartbeatInterval)}})}j.prototype.CallTQL=function(e,d,b){if(!this.ws||typeof this.ws.readyState!=="number")return setTimeout(b.bind(null,"The connection is not yet open.",null),0);if(this.ws.readyState===0)return setTimeout(b.bind(null,"The connection is not yet open.",null),0);if(this.ws.readyState===2)return setTimeout(b.bind(null,"The connection is in the process of closing.",null),0);if(this.ws.readyState===1&&this.touchState===false)return setTimeout(this.CallTQL.bind(null,e,d,b),500);if(this.ws.readyState===3)return setTimeout(b.bind(null,"The connection is closed or couldn't be opened.",null),0);var f=a.getUID("number"),g="TQL:"+f,c="";c+="TQL?";c+=a.jsonToQuery({TransKey:f,Entry:e})+"|";c+=d;this.ws.send(c);this.on(g,function(a){b(null,a.data,a.info)})};j.prototype.login=function(a){a.call(this,c.getItem(this.infoKey),function(a){c.setItem(this.infoKey,a);this.emit("online",c.getItem(this.infoKey))})};var k=function(){var f="";function k(b){var c=[],a;for(a in b)b.hasOwnProperty(a)&&c.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c.join("&")}function j(b){var a=this.state==="reconnect";console.log("error >>",arguments);if(!a){this.state="error";this.emit("error",b)}}function h(){this.state="alive";console.log("alive >>",arguments);this.emit("alive");if(Array.isArray(this.caches)){this.caches.forEach(function(a){this.send.apply(this,a.args)},this);this.caches=[]}}function d(a){return function(c){var d=c.responseText,b=c.status;return b<100?a("NET_ERR_"+b+": \u5ba2\u6237\u7aef\u7f51\u7edc\u9519\u8bef\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5"):b<200?a("INFO_ERR_"+b+": \u5e94\u7b54\u9519\u8bef"):b<300?a("AJAX_ERR_"+b+": "+c.statusText):b<400?a("REDIRECT_ERR_"+b+": \u91cd\u5b9a\u5411\u9519\u8bef"):b<500?a("CLIENT_ERR_"+b+": \u8bbf\u95ee\u9519\u8bef"):a("SERVER_ERR_"+b+": "+d)}}function b(a,b){console.log("cookie before send "+a+": "+document.cookie);var c={type:"GET",url:"/"+a+"?"+(a==="TOUCH"?f:"")};c.success=function(c){console.log("cookie after send "+a+": "+document.cookie);if(c.length>0&&c.substr(2,5)!=="-5100")b("TS_ERROR:"+c);else b(null)};c.error=d(b);$.ajax(c)}function g(a){this.lastCallTime=+new Date;if(a)this.evt.emit("error",a);else{this.evt.emit("alive");clearTimeout(this.heartbeatTick);this.heartbeatTick=setTimeout(b.bind(null,"ALIVE",g.bind(this)),20*1e3)}}function a(){this.state="init";this.heartbeatTick=-1;this.lastCallTime=0;this.evt=i("system");this.evt.on("error",function(b,a){j.call(this,a)}.bind(this)).on("alive",function(b,a){h.call(this,a)}.bind(this));var a=i("user");this.cEvt=a;l(this,a);f=k({Device:"Browser",Ip:"0.0.0.0",Mac:"00-00-00-00-00-00-00-00",Build:"WEB",Type:"41",Ver:"1.0.0",EP:"0"})}a.prototype.connect=function(a){a=a||"";if(a.length<=0)a="error";else a=a+"-error";b("TOUCH",function(b){b=b||"";var d="SERVER_ERR_503: E|-5100|\u4e8b\u52a1\u4e2d\u95f4\u4ef6\u6b63\u5f0f\u7248(-5100):\u521b\u5efaSESSION\u5931\u8d25(\u5df2\u7ecf\u5b58\u5728)";if(b.substr(0,24)===d.substr(0,24))b=null;if(b)this.evt.emit(a,b);else{var e=c.getItem("ASPSessionID");if(!e)this.evt.emit(a,"Set-Cookie \u5931\u8d25");else g.call(this,b)}}.bind(this));return this};a.prototype.reconnect=function(c,a){a=typeof a==="function"?a:function(){return false};if(this.state==="reconnect")return this.nextTick(a,"\u4e0d\u8981\u91cd\u590d\u8c03\u7528\u91cd\u8fde\u64cd\u4f5c");var b;function d(e,d){c-=1;if(c<=0){a(d||"\u91cd\u8fde\u5931\u8d25");this.evt.unbind("reconnect-error",b);this.state="error"}else setTimeout(this.connect.bind(this,"reconnect"),1e3)}b=d.bind(this);this.evt.once("alive",function(){this.evt.unbind("reconnect-error",b);a(null)}.bind(this));c=Math.max(1,parseInt(c,10)||1);this.evt.on("reconnect-error",b);this.state="reconnect";this.connect("reconnect");return this};a.prototype.resetConnect=function(a){clearTimeout(this.heartbeatTick);b("QUIT",function(){this.reconnect(1,a)}.bind(this))};a.prototype.send=function(c,e,a){if(this.state==="init"||this.state==="reconnect")return this.cache(arguments);if(this.state==="error")return this.nextTick(a,"\u5ba2\u6237\u7aef\u8fde\u63a5\u670d\u52a1\u5668\u5931\u8d25\uff0c\u8bf7\u91cd\u8fde\u540e\u518d\u5c1d\u8bd5\u3002");console.log("cookie before send tql: "+document.cookie);$.ajax({url:"/TQL?Entry="+c,type:"POST",data:e,success:a.bind(null,null),error:d(function(c){this.state==="alive"&&b("ALIVE",function(a){if(a){clearTimeout(this.heartbeatTick);this.evt.emit("error",a)}}.bind(this));a(c)}.bind(this))});return this};a.prototype.CallTQL=a.prototype.send;a.prototype.cache=function(a){this.caches=this.caches||[];this.caches.push({args:a,timestamp:new Date});console.log("cache.size = "+this.caches.length);return this};a.prototype.nextTick=function(a){var b=Array.prototype.slice.call(arguments,1);setTimeout(function(){a.apply(null,b)},0);return this};a.prototype.login=function(c,d){var a={},b;for(b in c)if(c.hasOwnProperty(b))a[b]=c[b];this.send("ACL:checkuser",JSON.stringify([a]),function(c,b){if(!c){this.localSet("ACL_CHECKUSER_REQ",JSON.stringify(a));this.localSet("ACL_CHECKUSER_ANS",b)}d(c,b)}.bind(this));a.PWD=""};a.prototype.getLoginHistory=function(){return{req:this.localGet("ACL_CHECKUSER_REQ"),ans:this.localGet("ACL_CHECKUSER_ANS")}};var e="TS_CLIENT";a.prototype.localSet=function(b,a){return o(e,b,a)};a.prototype.localGet=function(a){return n(e,a)};return a}();function h(b){b=b||{};StateManager.call(this,b);var a=this,c=b.basePath||"/tq";this.handle={connect:c+"/Conn",execute:c+"/Exec",addJob:c+"/Add",pushMsg:c+"/Push",exit:c+"Fakelogout"};this.ekey="";this.ckey="";this.ap="";this.openid=b.openid;this.connectTimes=20;this.retryInterval=2e3;this.timeout=b.timeout||3e4;(function d(){$.ajax({url:a.handle.connect,type:"POST",cache:false,timeout:a.timeout,data:{openid:a.openid},success:function(b){try{b=$.parseJSON(b)[0];var e=["ekey","ckey","ap"],c,f;for(c=0,f=e.length;c<f;++c)if(!b[e[c]])throw"\u6ca1\u6709\u83b7\u53d6\u5230\u5173\u952e\u5b57\u6bb5 "+e[c];}catch(g){a.connectTimes-=1;return a.connectTimes<0?a.emit("error","\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668(conn)\u3002"+g):setTimeout(d,a.retryInterval)}a.ekey=b.ekey;a.ckey=b.ckey;a.ap=b.ap;a.emit("touch")},error:function(e,c,b){a.connectTimes-=1;return a.connectTimes<0?a.emit("error","\u65e0\u6cd5\u8fde\u63a5\u670d\u52a1\u5668(AJAX)\u3002"+b):setTimeout(d,a.retryInterval)}});a.on("touch",function(){return false})})()}h.prototype.ExecJob=function(c,b,a){$.ajax({url:this.handle.execute,type:"POST",cache:false,data:{ap:this.ap,funcid:c,bodystr:b,timeout:this.timeout},success:function(b){var c;try{c=b.split("|")[0];b=b.substr(c.length+1)}catch(d){return a("error",d)}a(c,b)},error:function(d,b,c){b=b==="timeout"?"timeout":"error";a(b,c)}})};h.prototype.AddJob=function(){return false};d.CreateTDXClient=function(a){a=a||{};switch(String(a.serverType).toLowerCase()){case"tshttp":return new k(a);case"tsws":return new j(a);case"tomcat":return new h(a);default:return new k(a)}};d.TDXClientLite=function(a){switch(String(a).toLowerCase()){case"ios":return b.iOS;case"android":return b.Android;case"debug":return m;case"tqlex":return function(){return function(b,c,a){m({entry:b,data:c,callback:a})}}();case"vary":return function(){return b.PC3}();default:return function(){return window.hasOwnProperty("TDXQuery")?b.PC2:b.PC}()}}})(window)